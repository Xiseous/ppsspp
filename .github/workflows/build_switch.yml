name: Build Switch

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-switch:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkita64:latest
      
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: Mark git directory as safe
      run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

    - name: Install bundled libnx and switch-mesa for FW 21.x
      run: |
        # Install bundled packages from repo (avoids 403 from devkitPro servers)
        # These packages were downloaded from wii.leseratte10.de mirror
        echo "Installing bundled libnx-4.10.0 and switch-mesa-20.1.0-5..."
        dkp-pacman -U --noconfirm switch-packages/libnx-4.10.0-1-any.pkg.tar.zst
        dkp-pacman -U --noconfirm switch-packages/switch-mesa-20.1.0-5-any.pkg.tar.zst
        # Verify installed versions
        echo "Installed package versions:"
        dkp-pacman -Q libnx switch-mesa devkitA64

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y cmake ninja-build wget
        
    - name: Fetch missing assets
      run: |
        mkdir -p android/assets
        # Download ui_atlas from upstream if missing
        if [ ! -f "android/assets/ui_atlas.zim" ]; then
          wget -q "https://github.com/hrydgard/ppsspp/raw/v1.19.3/android/assets/ui_atlas.zim" -O android/assets/ui_atlas.zim || true
          wget -q "https://github.com/hrydgard/ppsspp/raw/v1.19.3/android/assets/ui_atlas.meta" -O android/assets/ui_atlas.meta || true
        fi
        # Copy ui_atlas to main assets folder for Switch packaging
        cp android/assets/ui_atlas.* assets/ 2>/dev/null || true
        ls -la assets/ui_atlas* 2>/dev/null || echo "ui_atlas not found"
        
    - name: Patch Lua Headers for C++ Compatibility
      run: cp ext/lua-fixed/*.h ext/lua/

    - name: Patch Freetype to skip libdl on Switch
      run: |
        # Patch freetype CMakeLists.txt to add USE_LIBNX check around dl linking
        sed -i 's/if (FT_DYNAMIC_HARFBUZZ_ENABLED AND FT_NEED_LIBDL)/if (FT_DYNAMIC_HARFBUZZ_ENABLED AND FT_NEED_LIBDL AND NOT USE_LIBNX)/' ext/freetype/CMakeLists.txt

    - name: Configure CMake
      run: |
        . /etc/profile.d/devkit-env.sh
        mkdir -p build-switch
        cd build-switch
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=/opt/devkitpro/cmake/Switch.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_LIBNX=ON \
          -DUSING_GLES2=ON \
          -DUSE_FFMPEG=OFF \
          -DUSE_DISCORD=OFF \
          -DUSE_MINIUPNPC=OFF \
          -DUSE_MINIUPNPC=OFF \
          -DHEADLESS=OFF

    - name: Build
      shell: bash
      run: |
        cd build-switch
        # Use pipefail to catch build errors while piping
        set -o pipefail
        ninja -t targets | grep "PPSSPP" || true
        (ninja -v PPSSPPSDL || ninja -v -j1 PPSSPPSDL) | tee build.log

    - name: Create NRO
      run: |
        . /etc/profile.d/devkit-env.sh
        cd build-switch
        nacptool --create "PPSSPP" "PPSSPP Team" "1.19.3" ppsspp.nacp
        elf2nro PPSSPPSDL.elf PPSSPP.nro --nacp=ppsspp.nacp --icon=../icons/icon-114.png

    - name: Package for Switch
      run: |
        mkdir -p ppsspp-switch/switch/ppsspp
        cp build-switch/PPSSPP.nro ppsspp-switch/switch/ppsspp/
        cp -r assets ppsspp-switch/switch/ppsspp/
        # Remove unnecessary files from assets to reduce size
        rm -rf ppsspp-switch/switch/ppsspp/assets/debugger || true
        rm -rf ppsspp-switch/switch/ppsspp/assets/upload || true
        echo "Package contents:"
        ls -la ppsspp-switch/switch/ppsspp/
        du -sh ppsspp-switch/

    - name: List build outputs
      if: always()
      run: |
        ls -la build-switch/ 2>/dev/null | head -30 || echo "No build directory"

    - name: Upload Build Logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build-switch/CMakeFiles/*.log
          build-switch/build.log
        
    - name: Upload Switch Package
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ppsspp-switch
        path: ppsspp-switch/
        if-no-files-found: error

    - name: Upload ELF (for debugging)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: ppsspp-switch-debug
        path: build-switch/PPSSPPSDL.elf
        if-no-files-found: ignore

name: Build Switch

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-switch:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkita64:latest
      
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: Install additional dependencies
      run: |
        apt-get update
        apt-get install -y cmake ninja-build wget
        
    - name: Fetch assets from upstream
      run: |
        # Download assets from upstream PPSSPP releases if not present
        if [ ! -f "android/assets/ui_atlas.zim" ]; then
          echo "Downloading assets from upstream..."
          mkdir -p android/assets
          # Download from upstream v1.12.3 release
          wget -q https://github.com/hrydgard/ppsspp/raw/v1.12.3/android/assets/ui_atlas.zim -O android/assets/ui_atlas.zim || true
          wget -q https://github.com/hrydgard/ppsspp/raw/v1.12.3/android/assets/ui_atlas.meta -O android/assets/ui_atlas.meta || true
        fi
        # If wget failed, create placeholder from assets directory
        if [ ! -f "android/assets/ui_atlas.zim" ] && [ -f "assets/ppge_atlas.zim" ]; then
          echo "Creating placeholder assets..."
          cp assets/ppge_atlas.zim android/assets/ui_atlas.zim || true
          cp assets/ppge_atlas.meta android/assets/ui_atlas.meta || true
        fi
        ls -la android/assets/ || true
        
    - name: Configure CMake
      run: |
        . /etc/profile.d/devkit-env.sh
        mkdir -p build-switch
        cd build-switch
        cmake .. \
          -G Ninja \
          -DCMAKE_TOOLCHAIN_FILE=/opt/devkitpro/cmake/Switch.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DUSE_LIBNX=ON \
          -DUSING_GLES2=ON \
          -DUSE_FFMPEG=OFF \
          -DUSE_DISCORD=OFF \
          -DUSE_MINIUPNPC=OFF \
          -DHEADLESS=OFF
          
    - name: Build
      run: |
        cd build-switch
        ninja -j$(nproc) || ninja -j1
        
    - name: Create NRO
      run: |
        . /etc/profile.d/devkit-env.sh
        cd build-switch
        echo "Build complete"
        ls -la
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ppsspp-switch
        path: |
          build-switch/PPSSPP*
          build-switch/*.nro
          build-switch/*.elf
        if-no-files-found: ignore

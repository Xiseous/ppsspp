name: Build Switch

on:
  push:
    branches:
    - master
    - main
    tags:
      - "v*.*"
  pull_request:
    branches:
    - master
    - main
  workflow_dispatch:

env:
  BUILD_CONFIGURATION: Release
  PPSSPP_VERSION: v1.19.3

jobs:
  build-switch:
    runs-on: ubuntu-latest
    container:
      image: devkitpro/devkita64:latest

    steps:
    - name: Clone PPSSPP from official repository
      run: |
        # Fix dubious ownership issue in containers
        git config --global --add safe.directory /__w/ppsspp/ppsspp
        git config --global --add safe.directory "$GITHUB_WORKSPACE"
        git config --global --add safe.directory "*"
        
        git clone --recursive https://github.com/hrydgard/ppsspp.git .
        git checkout ${{ env.PPSSPP_VERSION }}
        git submodule update --init --recursive

    - name: Apply Switch patches
      run: |
        # Fix invalid #undef syntax in CommonTypes.h (can't undef namespace-qualified names)
        sed -i 's/#undef KeyInputFlags::UP/\/\/ #undef KeyInputFlags::UP/' Common/CommonTypes.h
        sed -i 's/#undef KeyInputFlags::DOWN/\/\/ #undef KeyInputFlags::DOWN/' Common/CommonTypes.h
        
        # Add #undef BIT and BreakReason after switch.h include (libnx conflicts with PPSSPP)
        sed -i 's/#undef ThreadContext/#undef ThreadContext\n#undef BIT\n#undef BreakReason/' Common/CommonTypes.h
        
        # Disable armips for Switch (filesystem library not compatible)
        sed -i 's/add_subdirectory(armips)/if(NOT USE_LIBNX)\n\tadd_subdirectory(armips)\nendif()/' ext/CMakeLists.txt
        
        # Disable armips linking for Switch
        sed -i 's/set(CoreExtraLibs \${CoreExtraLibs} armips)/if(NOT USE_LIBNX)\n\tset(CoreExtraLibs \${CoreExtraLibs} armips)\nendif()/' CMakeLists.txt
        
        # Wrap armips include in SymbolMap.cpp
        sed -i 's/#include "ext\/armips\/Core\/Assembler.h"/#ifndef HAVE_LIBNX\n#include "ext\/armips\/Core\/Assembler.h"\n#endif/' Core/Debugger/SymbolMap.cpp

    - name: Patch MIPSAsm.cpp for Switch
      run: |
        cat > Core/MIPS/MIPSAsm.cpp << 'ENDOFFILE'
        // MIPSAsm.cpp - MIPS assembler using armips
        // Disabled for Switch/libnx builds as armips doesn't support the platform
        
        #include "ppsspp_config.h"
        
        #ifndef HAVE_LIBNX
        
        #include <cstdarg>
        #include <cstring>
        #include <memory>
        #include <string_view>
        #include <vector>
        
        #include "Common/CommonTypes.h"
        #include "ext/armips/Core/Assembler.h"
        #include "ext/armips/Core/FileManager.h"
        #include "Core/Debugger/SymbolMap.h"
        #include "Core/MemMapHelpers.h"
        #include "Core/MIPS/MIPSAsm.h"
        
        class PspAssemblerFile : public AssemblerFile {
        public:
        	PspAssemblerFile() {
        		address = 0;
        	}
        
        	bool open(bool onlyCheck) override{ return true; };
        	void close() override { };
        	bool isOpen() override { return true; };
        	bool write(void *data, size_t length) override {
        		if (!Memory::IsValidAddress((u32)(address+length-1)))
        			return false;
        
        		Memory::Memcpy((u32)address, data, (u32)length, "Debugger");
        		
        		// In case this is a delay slot or combined instruction, clear cache above it too.
        		mipsr4k.InvalidateICache((u32)(address - 4), (int)length + 4);
        
        		address += length;
        		return true;
        	}
        	int64_t getVirtualAddress() override { return address; };
        	int64_t getPhysicalAddress() override { return getVirtualAddress(); };
        	int64_t getHeaderSize() override { return 0; }
        	bool seekVirtual(int64_t virtualAddress) override {
        		if (!Memory::IsValidAddress(virtualAddress))
        			return false;
        		address = virtualAddress;
        		return true;
        	}
        	bool seekPhysical(int64_t physicalAddress) override { return seekVirtual(physicalAddress); }
        	const fs::path &getFileName() override { return dummyFilename_; }
        private:
        	u64 address;
        	fs::path dummyFilename_;
        };
        
        bool MipsAssembleOpcode(std::string_view line, DebugInterface *cpu, u32 address, std::string *error) {
        	std::vector<std::string> errors;
        
        	char str[64];
        	snprintf(str, 64, ".psp\n.org 0x%08X\n", address);
        
        	ArmipsArguments args;
        	args.mode = ArmipsMode::MEMORY;
        	args.content = str + std::string(line);
        	args.silent = true;
        	args.memoryFile.reset(new PspAssemblerFile());
        	args.errorsResult = &errors;
        
        	if (g_symbolMap) {
        		g_symbolMap->GetLabels(args.labels);
        	}
        
        	error->clear();
        	if (!runArmips(args)) {
        		for (size_t i = 0; i < errors.size(); i++) {
        			(*error) += errors[i];
        			if (i != errors.size() - 1)
        				error->push_back('\n');
        		}
        
        		return false;
        	}
        
        	return true;
        }
        
        #else // HAVE_LIBNX
        
        // Stub implementation for Switch - assembler not available
        #include <string>
        #include <string_view>
        #include "Common/CommonTypes.h"
        
        class DebugInterface;
        
        bool MipsAssembleOpcode(std::string_view line, DebugInterface *cpu, u32 address, std::string *error) {
        	if (error) {
        		*error = "Assembler not available on this platform";
        	}
        	return false;
        }
        
        #endif // HAVE_LIBNX
        ENDOFFILE

    - name: Install Switch dependencies
      shell: bash
      run: |
        dkp-pacman -S --noconfirm --needed \
          switch-dev \
          switch-sdl2 \
          switch-mesa \
          switch-glad \
          switch-glm \
          switch-libdrm_nouveau \
          switch-zlib \
          switch-bzip2 \
          switch-libpng \
          switch-freetype \
          switch-libjpeg-turbo \
          libnx \
        || echo "Package installation had issues, continuing with pre-installed packages..."
        
        . $DEVKITPRO/switchvars.sh
        which aarch64-none-elf-gcc || (echo "ERROR: aarch64-none-elf-gcc not found" && exit 1)
        echo "All required tools found!"

    - name: Create git-version.cpp
      run: |
        GIT_VERSION="${{ env.PPSSPP_VERSION }}"
        echo "Building version: $GIT_VERSION"
        echo "const char *PPSSPP_GIT_VERSION = \"$GIT_VERSION\";" > git-version.cpp
        echo "#define PPSSPP_GIT_VERSION_NO_UPDATE 1" >> git-version.cpp

    - name: Configure CMake for Switch
      shell: bash
      run: |
        . $DEVKITPRO/switchvars.sh
        mkdir -p build-switch
        cd build-switch
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=$DEVKITPRO/cmake/Switch.cmake \
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_CONFIGURATION }} \
          -DUSE_LIBNX=ON \
          -DUSING_GLES2=ON \
          -DMOBILE_DEVICE=ON \
          -DUSE_FFMPEG=OFF \
          -DUSE_DISCORD=OFF \
          -DUSE_MINIUPNPC=OFF \
          -DHEADLESS=OFF \
          -DUNITTEST=OFF \
          -DCMAKE_DISABLE_FIND_PACKAGE_SDL2_ttf=ON \
          -DCMAKE_DISABLE_FIND_PACKAGE_Fontconfig=ON

    - name: Build PPSSPP for Switch
      shell: bash
      run: |
        . $DEVKITPRO/switchvars.sh
        cd build-switch
        make -j$(nproc) 2>&1 | tee build.log || (tail -200 build.log && exit 1)

    - name: Generate NRO file
      shell: bash
      run: |
        . $DEVKITPRO/switchvars.sh
        cd build-switch
        if [ -f PPSSPPSDL ]; then
          nacptool --create "PPSSPP" "PPSSPP Team" "${{ env.PPSSPP_VERSION }}" ppsspp.nacp
          elf2nro PPSSPPSDL PPSSPPSDL.nro --icon=../icons/icon-114.png --nacp=ppsspp.nacp || \
          elf2nro PPSSPPSDL PPSSPPSDL.nro --nacp=ppsspp.nacp || \
          elf2nro PPSSPPSDL PPSSPPSDL.nro
        fi

    - name: Package build
      run: |
        mkdir -p ppsspp-switch/switch/ppsspp
        if [ -f build-switch/PPSSPPSDL.nro ]; then
          cp build-switch/PPSSPPSDL.nro ppsspp-switch/switch/ppsspp/PPSSPP.nro
        elif [ -f build-switch/PPSSPPSDL ]; then
          cp build-switch/PPSSPPSDL ppsspp-switch/switch/ppsspp/PPSSPP.nro
        fi
        cp -r assets ppsspp-switch/switch/ppsspp/assets

    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: PPSSPP-Switch-${{ env.PPSSPP_VERSION }}-${{ github.sha }}
        path: ppsspp-switch/

    - name: Create release archive
      if: github.ref_type == 'tag'
      run: |
        cd ppsspp-switch
        zip -r ../PPSSPP-Switch-${{ github.ref_name }}.zip .

    - name: Upload release
      uses: softprops/action-gh-release@v2
      if: github.ref_type == 'tag'
      with:
        files: PPSSPP-Switch-${{ github.ref_name }}.zip
        body: |
          PPSSPP for Nintendo Switch - ${{ github.ref_name }}
          
          ## Installation
          1. Extract the archive to the root of your SD card
          2. The folder structure should be: `/switch/ppsspp/PPSSPP.nro`
          3. Launch via Homebrew Menu
          
          ## Requirements
          - Nintendo Switch with Homebrew access
          - Custom firmware (Atmosphere recommended)
